version: '3'
services:
  geth:
    image: trufflesuite/ganache-cli
    ports:
      - 8545:8545
    command: 
      - ganache-cli
      - "-l 8000000"
      - "-g 1000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501200,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501201,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501202,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501203,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501204,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501205,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501206,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501207,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501208,1000000000000000000000000"
      - --account
      - "0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501209,1000000000000000000000000"
      
  nodedb:
    image: postgres
    ports:
      - 54321:54322
    restart: on-failure
    environment:
      - POSTGRES_PASSWORD=bitclave
      - POSTGRES_USER=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      
  base-node:
    image: base/node
    ports:
      - 8080:8080
    depends_on:
      - nodedb
      - geth
    environment:
      - PROFILE=docker
      - PORT=8080
      - RT_SEARCH_URL=http://rt-search:5001/
      - JDBC_DATABASE_URL=jdbc:postgresql://nodedb:5432/postgres
      - JDBC_DATABASE_USERNAME=postgres
      - JDBC_DATABASE_PASSWORD=bitclave
      - ETHEREUM_RPC_URL=http://geth:8545/
      - OWNER_PRIVATE_KEY=0x2bdd21761a483f71054e14f5b827213567971c676928d9a1808cbfa4b7501200
      - DNS_CONTRACT_ADDRESS=0x0f5ea0a652e851678ebf77b69484bfcd31f9459b
      - ETHEREUM_GAS_PRICE=8000000
      - ETHEREUM_GAS_LIMIT=8000000
      
  matcher:
    image: base/matcher
    depends_on:
      - base-node
    restart: on-failure
    environment: 
      - BASE_NODE_URL=http://base-node:8080/
    
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.6.1
    container_name: elasticsearch
    ports:
      - 9300:9300
      - 9200:9200
    environment:
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata:/usr/share/elasticsearch/data
      
  rt-search:
    image: base/rt-search
    ports:
      - 5001:5001
    depends_on:
      - base-node
      - elasticsearch
    restart: on-failure
    environment:
      - PROFILE=docker
      - PORT=5001
      - NODE_END_POINT=http://base-node:8080/
      - ELASTIC_CLUSTER_NAME=docker-cluster
      - ELASTIC_HOST=elasticsearch
      - ELASTIC_PORT=9300
      - ELASTIC_OFFER_INDEX_NAME=docker-offer

volumes:
  postgres_data: {}
  esdata:
    driver: local
